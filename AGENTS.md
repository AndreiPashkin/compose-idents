# Compose-Idents guide for OpenAI Codex

This Markdown file provides guidance for OpenAI Codex and other AI agents working with this project.

## Project Overview

This project is called Compose-Idents, and it is a Rust procedural macro that uses Cargo follows standard layout.

It uses such tools as Task, Gomplate, Pre-commit, Clippy, Rustfmt besides Cargo.

## Project Structure

- `README.md`: User-facing documentation of the project.
- `adr/`: Contains Architecture Decision Records (ADRs) in MADR format that document significant architectural decisions
          made during the development of the project.
    - `kb/`: Contains articles that capture knowledge important for the development of the project.
        - `template.md`: A template for new KB-files.
    - `template.md`: A template for new ADR-files.
- `src/`: Source code that OpenAI Codex should analyze
    - `interpreter.rs`: Implementation of the interpreter for the macro. It executes the code passed by the user to
                        the macro, and it loosely follows the tree-walk interpreter design as described in:
                        https://craftinginterpreters.com/a-tree-walk-interpreter.html
    - `ast/`: Types that represent AST elements of the syntax accepted by the macro.
    - `parse/`: Implementation of the parsing phase of the interpreter. Contains implementations of `syn::Parse` trait
                for different AST types.
    - `resolve/`: Implementation of the resolve-phase if the interpreter - it performs static-analysis.
    - `eval/`: Implementation of the eval-phase of the interpreter - it performs execution of the code.
    - `util/`: Contains various auxiliary utilities.
- `tests/`: Tests of the project. Most tests rely on [`trybuild`][1] crate.

## General Instructions

- You may read `README.md` to understand the project and its purpose.
- You may read `CHANGELOG.md` to see recent changes and updates.

## Coding Conventions

### General Conventions

- Generally prefer to follow [Rust Style Guide](https://doc.rust-lang.org/stable/style-guide/).
- Use [the Rust Book](https://doc.rust-lang.org/stable/book/index.html) for a reference on idiomatic Rust code.
- Aim to write idiomatic Rust code
- Follow general principles of writing maintainable code:
  - DRY (Don't Repeat Yourself).
  - KISS (Keep It Simple, Stupid).
  - SPR (Single Responsibility Principle).
  - YAGNI (You Aren't Gonna Need It).
  - Separation of Concerns.
  - Write Self-Documenting Code.
  - Prefer avoiding overly large functions and modules.
  - Etc.
- Follow general OOP principles.
- Follow the existing code style in each existing file.
- Add comments for complex code, sophisticated algorithms, etc.

## Testing

The project's tests consist of unit tests and end-to-end tests.

The unit-tests are either regular Rust's unit-tests, or unit-tests written using [`rstest`][2] crate. In particular -
it's test parametrization capability is used frequently.

The end-to-end tests are written using the [`trybuild`][1] crate, which allows to test the macro by compiling standalone
modules with its invocations.

In general unit-tests are preferred over end-to-end tests, as they are faster and easier to write and maintain. So the
rule of thumb is to write unit-tests whenever possible, and use end-to-end tests only when necessary.

Tests can be executed with the following commands:

```bash
# Runs all tests
cargo test

# Runs a specific test file, used by trybuild
cargo test -- compile_tests trybuild=tests/compile/simple_compose.rs

# Run a specific unit-test
cargo test parse_arg_ident_terminated
```

## Documentation

The documentation is generated from Gomplate templates that use `.tpl` file extension. The docs generation can be
triggered by `task render` command. The `snippets` directory contains some code snippets and templates that are used
to generate the documentation.

## Pull Request Guidelines

When OpenAI Codex helps create a PR, please ensure it:

1. Includes a clear description of the changes as guided by AGENTS.md
2. References any related issues that OpenAI Codex is addressing
3. Ensures all tests pass for code generated by OpenAI Codex
4. Includes screenshots for UI changes implemented with OpenAI Codex
5. Keeps PRs focused on a single concern as specified in AGENTS.md

## Static analysis and Linting

Before submitting changes, please run:
```bash
# Lint check - uses Clippy, Cargo Check, Rustfmt and some other tools
task lint
```

You can also use these lints individually during work - they run faster:
```bash
# Cargo check
cargo check

# Clippy check
cargo clippy
```

Please make sure tests and lints are passing before submitting the changes.

[1]: https://docs.rs/trybuild/
[2]: https://docs.rs/rstest/
